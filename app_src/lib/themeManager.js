import './CSInterface'

import DarkTheme from './topcoat/css/topcoat-desktop-dark.min.css'
import LightTheme from './topcoat/css/topcoat-desktop-light.min.css'

function computeValue(value, _delta) {
	const delta = _delta || 0
	const computedValue = Math.floor(Math.max(0, Math.min(255, value + delta))).toString(16)

	return computedValue.padStart(2, '0')
}

function toHex(color, delta) {
	if (!color) {
		return ''
	}

	return [color.red, color.green, color.blue]
		.map((colorValue) => computeValue(colorValue, delta))
		.join('')
}

function addRule(stylesheetId, selector, rule) {
	var stylesheet = document.getElementById(stylesheetId)
	if (stylesheet) {
		stylesheet = stylesheet.sheet
		if (stylesheet.addRule) {
			stylesheet.addRule(selector, rule)
		} else if (stylesheet.insertRule) {
			stylesheet.insertRule(`${selector} { ${rule} }`, stylesheet.cssRules.length)
		}
	}
}

function updateThemeWithAppSkinInfo(appSkinInfo) {
	var panelBgColor = appSkinInfo.panelBackgroundColor.color
	var lightBgdColor = toHex(panelBgColor, 20)
	var darkBgdColor = toHex(panelBgColor, -20)
	var bgdColor = toHex(panelBgColor)
	var isLight = panelBgColor.red >= 125
	var fontColor = isLight ? '000000' : 'F0F0F0'
	var styleId = 'hostStyle'

	addRule(styleId, '.hostElt', `background-color: #${bgdColor}`)
	addRule(styleId, '.hostElt', `font-size: ${appSkinInfo.baseFontSize}px;`)
	addRule(styleId, '.hostElt', `font-family: ${appSkinInfo.baseFontFamily}`)
	addRule(styleId, '.hostElt', `color: #${fontColor}`)

	addRule(styleId, '.hostBgd', `background-color: #${bgdColor}`)
	addRule(styleId, '.hostBgdDark', `background-color: #${darkBgdColor}`)
	addRule(styleId, '.hostBgdLight', `background-color: #${lightBgdColor}`)

	addRule(styleId, '.hostBrd', `border: 1px solid #${bgdColor}`)
	addRule(styleId, '.hostBrdDark', `border: 1px solid #${darkBgdColor}`)
	addRule(styleId, '.hostBrdLight', `border: 1px solid #${lightBgdColor}`)
	addRule(
		styleId,
		'.hostBrdContrast',
		`border: 1px solid rgba(${isLight ? '0, 0, 0' : '255, 255, 255'}, 0.2)`
	)
	addRule(styleId, '.hostBrdTop', `border-top: 1px solid #${bgdColor}`)
	addRule(styleId, '.hostBrdTopDark', `border-top: 1px solid #${darkBgdColor}`)
	addRule(styleId, '.hostBrdTopLight', `border-top: 1px solid #${lightBgdColor}`)
	addRule(
		styleId,
		'.hostBrdTopContrast',
		`border-top: 1px solid rgba(${isLight ? '0, 0, 0' : '255, 255, 255'}, 0.2)`
	)
	addRule(styleId, '.hostBrdBot', `border-bottom: 1px solid #${bgdColor}`)
	addRule(styleId, '.hostBrdBotDark', `border-bottom: 1px solid #${darkBgdColor}`)
	addRule(styleId, '.hostBrdBotLight', `border-bottom: 1px solid #${lightBgdColor}`)
	addRule(
		styleId,
		'.hostBrdBotContrast',
		`border-bottom: 1px solid rgba(${isLight ? '0, 0, 0' : '255, 255, 255'}, 0.2)`
	)

	addRule(styleId, '.hostFontSize', `font-size: ${appSkinInfo.baseFontSize}px;`)
	addRule(styleId, '.hostFontFamily', `font-family: ${appSkinInfo.baseFontFamily}`)
	addRule(styleId, '.hostFontColor', `color: #${fontColor}`)
	addRule(styleId, '.hostFont', `font-size: ${appSkinInfo.baseFontSize}px;`)
	addRule(styleId, '.hostFont', `font-family: ${appSkinInfo.baseFontFamily}`)
	addRule(styleId, '.hostFont', `color: #${fontColor}`)

	addRule(styleId, '.hostButton', `background-color: #${darkBgdColor}`)
	addRule(styleId, '.hostButton:hover', `background-color: #${bgdColor}`)
	addRule(styleId, '.hostButton:active', `background-color: #${darkBgdColor}`)
	addRule(styleId, '.hostButton', `border-color: #${lightBgdColor}`)

	var topcoatCSS = document.getElementById('topcoat')
	topcoatCSS.href = isLight ? LightTheme : DarkTheme

	if (isLight) {
		document.body.classList.remove('dark-theme')
		document.body.classList.add('light-theme')
	} else {
		document.body.classList.remove('light-theme')
		document.body.classList.add('dark-theme')
	}
}

function onAppThemeColorChanged() {
	var skinInfo = JSON.parse(window.__adobe_cep__.getHostEnvironment()).appSkinInfo
	updateThemeWithAppSkinInfo(skinInfo)
}

const csInterface = new window.CSInterface()
updateThemeWithAppSkinInfo(csInterface.hostEnvironment.appSkinInfo)
csInterface.addEventListener(window.CSInterface.THEME_COLOR_CHANGED_EVENT, onAppThemeColorChanged)
